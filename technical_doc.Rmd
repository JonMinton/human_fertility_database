---
title: Merging, exploring, and batch processing data from the Human Fertility Database
  and Human Mortality Database
author: "Dr Jon Minton"
date: "Sunday, February 22, 2015"
output: html_document
---
#Introduction

This briefing paper will demonstrate how to use the R package `plyr` to merge all available data from the Human Mortality Database (HMD) and Human Fertility Database (HFD) into single datasets that follow a 'tidy data' format. With the data arranged in this format it then becomes easier to make comparisons between genders and groupings, and to automate the production of figures and other analyses for a large number of permutations of groups. 


##Accessing all available data from the HFD
- Go to humanfertility.org and select login from the Registration section of the column on the left of the page. 
- Once logged in, select 'Zipped Data Files' under the 'DATA' section of the column on the left of the page.
- Within the table 'Data by type', look for the link to the data type 'All types of HFD' data. Click on this link to begin the download.

The size of the HFD file is around 25Mb.  Once unzipped, this increases to around 144Mb. 



##Accessing all available data from the HMD
- Go to mortality.org and log in.
- Select 'Zipped Data Files'; scroll to the bottom of the page and click on the link in the table 'All countries for the HMD'. 

- Once logged in, select 'Zipped Data Files' under the 'DATA' section of the column on the left of the page.
- Within the table 'Data by type', look for the link to the data type 'All types of HFD' data. Click on this link to begin the download.

The size of the HMD file is around 311 Mb. Once unzipped, this increases to around 1.24 Gb. 

## Data preparation

This tutorial assumes that:
- the two zipped files above have been downloaded and unzipped
- the HFD file has been unzipped into a directory called hfd
- the HMD file has been unzipped into a directory called hmd
- that both the hfd and hmd directories are within a directory called raw_data

The directory structure assumed is:

base_dir
- data
-- raw_data
--- hfd
--- hmd


## Structure of hfd directory

The HFD has a relatively straightforward directory structure: within 'hfd' is a directory called 'Files', and within this directory is a directory called 'zip_w'. A total of 56 files are in this directory, and there are no additional directories.

## Structure of the hmd directory

The hmd directory has a more complex, branched structure. Once unzipped, the directory opens to 46 separate folders, each labelled with the country code of the country whose data they contain. Each of these country folders then has the same internal directory structure. As an example here is the directory structure of the first country by code, AUS:

- AUS
-- CHECKS
-- DOCS
-- InputDB
-- LexisDB
-- STATS

The STATS directory then contains 55 data files in comma-separated value (CSV) format. Within this technical document, the aim will be to extract data from the files `Deaths_1x1.txt` and `Populations.txt` from each of these subdirectories, but the methods described can be generalised to other operations.

# Data Management Concepts

## Tidy Data

Hadley Wickham defines a dataset as 'tidy' if:
1. Each variable forms a column.
2. Each observation forms a row.
3. Each type of observational unit forms a table. 

[REF: p4 of http://vita.had.co.nz/papers/tidy-data.pdf]

Each row within a 'tidy data' format table contains two types of variable:

1. Variables defining the location of the observation
2. Variables defining the value of the observation.

In the case of the demographic data of interest in this exercise, 'location' variables include:

1. Age;
2. Year;
3. Country;
4. Sex (for the HMD).

Each row therefore begins with the three (HFD) or four (HMD) location variables, followed by a number of observation variables for that particular location. These could include:

1. Death counts.
2. Population counts.
3. Births


With data arranged this format, it becomes easier to derive additional variables, to compare between groups, and to automate the production of outputs for each country separately. 


# Getting data from the HFD into 'tidy data' format


We begin by producing a list of all files in the relevant directory.

```{r}
file_names <- list.files(
  "data/raw_data/hfd/Files/zip_w/"
  )
```

A quick exploration of a few of the files in this directory shows that they are in a consistent format. The first line provides a description of the variable and the second line shows when the file was last modified. These first two lines are therefore 'metadata'.

The third line comprises the variable names (column names) for each variable in the dataset, each separated by at least one space, followed by a return character. The associated values for each variable then begins from the fourth line onwards. 

Knowing this we can therefore write a simple function which extracts, for each file, the description and also the variable names.

```{r}
fn <- function(x){
  inputs <- readLines(
    paste("data/hfd/Files/zip_w", x, sep="/"),
    n=3
    )
    
  return(list(    
    desc=inputs[1], # The first line
    vars=inputs[3]  # The third line
    ))
}
```

We can use `plyr`'s llply function to then apply this function to all files in the directory. 

```{r}
summaries <- llply(file_names, fn)
names(summaries) <- file_names
```

This summary object is a list object. To display it we simply type its name into the console: `summaries`. The first few rows of the output are displayed below.

```{r}
summaries
```

We can search for the files that contain tables with `Code`, `Year` and `Age` as variables, as these could then be combined.

```{r}

require(tidyr)
fn <- function(x, what){  
  vars_in_file <- str_split(x$vars, "[ ]{1,}")[[1]] # Split when at least
  # one space has been identified.
  check_against <- what
  out <- check_against %in% vars_in_file # which of the variables to be checked for
  # are in the file
  out <- all(out) # are all of the variables in the file?
  return(out)
}

cya_files <- sapply(summaries, fn, what=c("Code", "Year", "Age")) 

cya_files
```

cya_files can then be used to subset 

With this information, the following tables were identified as all including the same three location variables `Code`, `Year`, and `Age`:
-`asfrRR`
-`birthsRR`
-`cpfrRR`
- `exposRR`

Because they have the same location variables they can be combined within a single table. 
# 
# > summaries
# 
# $asfrRR.txt
# $asfrRR.txt$desc
# [1] "Period fertility rates by calendar year and age (Lexis squares, age in completed years (ACY))"
# 
# $asfrRR.txt$vars
# [1] "Code Year    Age        ASFR"
# 
# 
# $birthsRR.txt
# $birthsRR.txt$desc
# [1] "Live births by calendar year and age (Lexis squares, age in completed years (ACY))"
# 
# $birthsRR.txt$vars
# [1] "Code Year    Age        Total"
# 
# 
# 
# $cpfrRR.txt
# $cpfrRR.txt$desc
# [1] "Cumulative period fertility rates (Lexis squares)"
# 
# $cpfrRR.txt$vars
# [1] "Code Year    Age     CPFR"
# 
# 
# 
# $exposRR.txt
# $exposRR.txt$desc
# [1] "Female population exposure by calendar year and age (Lexis squares, age in completed years (ACY))"
# 
# $exposRR.txt$vars
# [1] "Code Year    Age        Exposure"



data_asfr <- read.table(
  file="data/hfd/Files/zip_w/asfrRR.txt",
  header=T,
  skip=2
  )

names(data_asfr) <- tolower(names(data_asfr))
data_asfr$age <- revalue(data_asfr$age, replace=c("12-" = "12", "55+" = "55"))
data_asfr$age <- as.numeric(as.character(data_asfr$age))


####

data_births <- read.table(
  file="data/hfd/Files/zip_w/birthsRR.txt",
  header=T,
  skip=2
)

names(data_births) <- tolower(names(data_births))
data_births$age <- revalue(data_births$age, replace=c("12-" = "12", "55+" = "55"))
data_asfr$age <- as.numeric(as.character(data_asfr$age))

####

data_cpfr <- read.table(
  file="data/hfd/Files/zip_w/cpfrRR.txt",
  header=T,
  skip=2
)

names(data_cpfr) <- tolower(names(data_cpfr))

####

data_expos <- read.table(
  file="data/hfd/Files/zip_w/exposRR.txt",
  header=T,
  skip=2
)

names(data_expos) <- tolower(names(data_expos))

data_combined <- join(
  x=data_asfr,
  y=data_births
  ) 

data_combined <- join(
  x=data_combined,
  y=data_cpfr
) 

data_combined <- join(
  x=data_combined,
  y=data_expos
) 


data_combined <- mutate(data_combined, birth_rate=total/exposure)

write.csv(
  data_combined,
  file="data/tidy/lexis_square_combined.csv"
  )
  
  




This is an R Markdown document. Markdown is a simple formatting syntax for authoring H
TML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
summary(cars)
```

You can also embed plots, for example:

```{r, echo=FALSE}
plot(cars)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
